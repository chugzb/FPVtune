import { randomUUID } from 'crypto';
import {
  GetObjectCommand,
  PutObjectCommand,
  S3Client,
} from '@aws-sdk/client-s3';
import { getSignedUrl } from '@aws-sdk/s3-request-presigner';
import { storageConfig } from '../config/storage-config';
import {
  ConfigurationError,
  type DownloadFileResult,
  type PresignedUploadUrlParams,
  type StorageConfig,
  StorageError,
  type StorageProvider,
  UploadError,
  type UploadFileParams,
  type UploadFileResult,
} from '../types';

/**
 * Amazon S3 storage provider implementation
 *
 * docs:
 * https://mksaas.com/docs/storage
 *
 * This provider works with Amazon S3 and compatible services like Cloudflare R2
 * https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html
 * https://www.npmjs.com/package/@aws-sdk/client-s3
 * https://developers.cloudflare.com/r2/
 */
export class S3Provider implements StorageProvider {
  private config: StorageConfig;
  private s3Client: S3Client | null = null;

  constructor(config: StorageConfig = storageConfig) {
    this.config = config;
  }

  /**
   * Get the provider name
   */
  public getProviderName(): string {
    return 'S3';
  }

  /**
   * Get the S3 client instance
   * 直接从 process.env 读取配置，确保在 Cloudflare Workers 中正确获取环境变量
   */
  private getS3Client(): S3Client {
    // 每次都从 process.env 读取，确保在 Cloudflare Workers 运行时正确获取
    const region = process.env.STORAGE_REGION || this.config.region;
    const endpoint = process.env.STORAGE_ENDPOINT || this.config.endpoint;
    const accessKeyId =
      process.env.STORAGE_ACCESS_KEY_ID || this.config.accessKeyId;
    const secretAccessKey =
      process.env.STORAGE_SECRET_ACCESS_KEY || this.config.secretAccessKey;
    const forcePathStyle = process.env.STORAGE_FORCE_PATH_STYLE !== 'false';

    console.log('[S3Provider] getS3Client config:', {
      region,
      endpoint,
      hasAccessKeyId: !!accessKeyId,
      accessKeyIdLength: accessKeyId?.length || 0,
      hasSecretAccessKey: !!secretAccessKey,
      secretAccessKeyLength: secretAccessKey?.length || 0,
    });

    if (!region) {
      throw new ConfigurationError('Storage region is not configured');
    }

    if (!accessKeyId || !secretAccessKey) {
      throw new ConfigurationError('Storage credentials are not configured');
    }

    const clientOptions: any = {
      region,
      credentials: {
        accessKeyId,
        secretAccessKey,
      },
    };

    // Add custom endpoint for S3-compatible services like Cloudflare R2
    if (endpoint) {
      clientOptions.endpoint = endpoint;
      clientOptions.forcePathStyle = forcePathStyle !== false;
    }

    // 不缓存 S3Client，每次都创建新的，确保使用最新的配置
    return new S3Client(clientOptions);
  }

  /**
   * Generate a unique filename with the original extension
   */
  private generateUniqueFilename(originalFilename: string): string {
    const extension = originalFilename.split('.').pop() || '';
    const uuid = randomUUID();
    return `${uuid}${extension ? `.${extension}` : ''}`;
  }

  /**
   * Upload a file to S3
   */
  public async uploadFile(params: UploadFileParams): Promise<UploadFileResult> {
    try {
      const { file, filename, contentType, folder } = params;
      const s3 = this.getS3Client();
      // 直接从 process.env 读取 bucketName
      const bucketName =
        process.env.STORAGE_BUCKET_NAME || this.config.bucketName;

      if (!bucketName) {
        throw new ConfigurationError('Storage bucket name is not configured');
      }

      const uniqueFilename = this.generateUniqueFilename(filename);
      const key = folder ? `${folder}/${uniqueFilename}` : uniqueFilename;

      // Convert Blob to Buffer if needed
      let fileBuffer: Buffer;
      if (file instanceof Blob) {
        fileBuffer = Buffer.from(await file.arrayBuffer());
      } else {
        fileBuffer = file;
      }

      // Upload the file
      const command = new PutObjectCommand({
        Bucket: bucketName,
        Key: key,
        Body: fileBuffer,
        ContentType: contentType,
      });

      await s3.send(command);

      // Generate the URL - 直接从 process.env 读取 publicUrl
      const publicUrl = process.env.STORAGE_PUBLIC_URL || this.config.publicUrl;
      let url: string;

      if (publicUrl) {
        // Use custom domain if provided
        url = `${publicUrl.replace(/\/$/, '')}/${key}`;
        console.log('uploadFile, public url', url);
      } else {
        // Generate a pre-signed URL if no public URL is provided
        const getCommand = new GetObjectCommand({
          Bucket: bucketName,
          Key: key,
        });
        url = await getSignedUrl(s3, getCommand, { expiresIn: 3600 * 24 * 7 }); // 7 days
        console.log('uploadFile, signed url', url);
      }

      return { url, key };
    } catch (error) {
      if (error instanceof ConfigurationError) {
        console.error('uploadFile, configuration error', error);
        throw error;
      }

      const message =
        error instanceof Error
          ? error.message
          : 'Unknown error occurred during file upload';
      console.error('uploadFile, error', message);
      throw new UploadError(message);
    }
  }

  /**
   * Delete a file from S3
   */
  public async deleteFile(key: string): Promise<void> {
    try {
      const s3 = this.getS3Client();
      // 直接从 process.env 读取 bucketName
      const bucketName =
        process.env.STORAGE_BUCKET_NAME || this.config.bucketName;

      if (!bucketName) {
        throw new ConfigurationError('Storage bucket name is not configured');
      }

      const command = {
        Bucket: bucketName,
        Key: key,
      };

      await s3.send(
        new PutObjectCommand({
          ...command,
          Body: '',
        })
      );
    } catch (error) {
      const message =
        error instanceof Error
          ? error.message
          : 'Unknown error occurred during file deletion';
      console.error('deleteFile, error', message);
      throw new StorageError(message);
    }
  }

  /**
   * Download a file from S3
   */
  public async downloadFile(key: string): Promise<DownloadFileResult> {
    try {
      const s3 = this.getS3Client();
      // 直接从 process.env 读取 bucketName，确保在 Cloudflare Workers 中正确获取
      const bucketName =
        process.env.STORAGE_BUCKET_NAME || this.config.bucketName;

      console.log('[S3Provider] downloadFile:', {
        key,
        bucketName,
        hasBucketName: !!bucketName,
      });

      if (!bucketName) {
        throw new ConfigurationError('Storage bucket name is not configured');
      }

      const command = new GetObjectCommand({
        Bucket: bucketName,
        Key: key,
      });

      console.log('[S3Provider] Sending GetObjectCommand...');
      const response = await s3.send(command);
      console.log('[S3Provider] GetObjectCommand response:', {
        hasBody: !!response.Body,
        contentType: response.ContentType,
        contentLength: response.ContentLength,
      });

      if (!response.Body) {
        throw new StorageError('File not found or empty');
      }

      // Convert stream to buffer
      const chunks: Uint8Array[] = [];
      for await (const chunk of response.Body as AsyncIterable<Uint8Array>) {
        chunks.push(chunk);
      }
      const content = Buffer.concat(chunks);

      console.log('[S3Provider] downloadFile success:', {
        key,
        contentLength: content.length,
      });

      return {
        content,
        contentType: response.ContentType,
      };
    } catch (error) {
      const message =
        error instanceof Error
          ? error.message
          : 'Unknown error occurred during file download';
      console.error('[S3Provider] downloadFile error:', {
        key,
        message,
        errorName: error instanceof Error ? error.name : 'Unknown',
        stack: error instanceof Error ? error.stack : undefined,
      });
      throw new StorageError(message);
    }
  }

  /**
   * Generate a pre-signed URL for direct browser uploads
   */
  public async getPresignedUploadUrl(
    params: PresignedUploadUrlParams
  ): Promise<UploadFileResult> {
    try {
      const { filename, contentType, folder, expiresIn = 3600 } = params;
      const s3 = this.getS3Client();
      // 直接从 process.env 读取 bucketName
      const bucketName =
        process.env.STORAGE_BUCKET_NAME || this.config.bucketName;

      if (!bucketName) {
        throw new ConfigurationError('Storage bucket name is not configured');
      }

      const uniqueFilename = this.generateUniqueFilename(filename);
      const key = folder ? `${folder}/${uniqueFilename}` : uniqueFilename;

      const command = new PutObjectCommand({
        Bucket: bucketName,
        Key: key,
        ContentType: contentType,
      });

      const url = await getSignedUrl(s3, command, { expiresIn });
      return { url, key };
    } catch (error) {
      const message =
        error instanceof Error
          ? error.message
          : 'Unknown error occurred while generating presigned URL';
      console.error('getPresignedUploadUrl, error', message);
      throw new StorageError(message);
    }
  }
}
